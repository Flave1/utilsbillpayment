@model  RechargeMeterModel
@{ ViewBag.Title = "Recharge";
    Layout = "~/Views/Shared/_Layout.cshtml"; }
<div class="dashright ">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    @*<link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">*@ 
    <div class="page-head">
        <h2>Recharge</h2>
    </div>
    <div class="cl-mcont">
        <div class="row">
            <div class="col-md-12">
                <div class="block-flat">
                    @if (Convert.ToBoolean(ViewBag.IsPlatformAssigned))
                    {
                        <div class="dashtop">
                            <label>Wallet Balance - </label>
                            <span id="balanceSpan" style="color:#00a2e8;">SSL : @(ViewBag.walletBalance == null ? "0" : string.Format("{0:N0}", ViewBag.walletBalance))</span>
                        </div>
                        <div class="contarea meterpage">
                            <div class="tabcont-row current">
                                <form id="rechargeForm">
                                    <div class="editpro-row">
                                        <div class="editpro-row50 meterrec" style="font-weight:bold;">
                                            <label>SELECT POS ID</label>
                                            @Html.DropDownList("PosId", new SelectList(ViewBag.userPos, "value", "text"), null, new { @id = "posDrp" })
                                        </div>
                                        <div style="width:100%; height:10px;float:left;"></div>
                                        <div class="editpro-row50 meterrec" style="font-weight:bold;">
                                            <label>METER NUMBER</label>
                                            @Html.TextBoxFor(x => x.MeterNumber, new { @class = "form-control", onkeypress = "javascript:return isNumber(event)", @onkeyup = "onChangeMeterNumber()" })
                                            @Html.ValidationMessageFor(x => x.MeterNumber)
                                        </div>
                                        <label class="optionor">OR</label>
                                        <div class="editpro-row50 meterrec" style="font-weight:bold;">
                                            <label>SELECT SAVED METER</label>
                                            @Html.DropDownList("MeterId", new SelectList(ViewBag.meters, "value", "text"), "Select Meter", new { @id = "meterDrp", @onchange = "onSelectMeter()" })
                                        </div>
                                        <div style="width:100%; height:10px;float:left; font-weight:bold; color:red;"></div>
                                        <div class="editpro-row50 meterrec">
                                            <label>AMOUNT</label>
                                            @*<span style="display:none; text-align:center; color:#db6d16;" id="displayErroMsg">Error messgae here</span>*@
                                            <input style="font-weight:bold; height:55px; font-size:45px;" id="AmountDisplay" type="text" onkeypress="javascript:return isNumber(event)" onkeyup="amountFormatter()" class="form-control" />
                                            @Html.HiddenFor(x => x.Amount, new { @class = "form-control" })
                                            @Html.ValidationMessageFor(x => x.Amount)


                                        </div>
                                        <div class="editpro-row50" style="width:100% !important;">
                                            <label>Save Meter <input style="margin-right:12px;" id="saveMeterChk" type="checkbox" class="form-control" /></label>

                                        </div>
                                        <div class="editpro-row submt" style="padding-left:25px !important;">
                                            <input type="button" disabled class="savebttn addDepositBtn" id="pay_Now_Btn" value="Pay Now">
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div> }
                    else
                    {
                        <div class="contarea">
                            <p>
                                Service not assigned<br />
                                Please contact VENDTECH on +23279990990
                            </p>
                        </div>
                    }


                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade colored-header colored-header-primary" id="form-bp1" tabindex="-1" role="dialog" aria-hidden="true" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-colored" style="background-color: #e4c200">
                <h3 class="modal-title" style="color:black; font-weight:bold; text-transform:capitalize;">Please Confirm your purchase</h3>
                <button class="close md-close" type="button" data-dismiss="modal" aria-hidden="true"><span class="mdi mdi-close">       </span></button>
            </div>
            <div class="modal-body">
                <div class="col-md-12">

                    <div class="row" style=" margin-top: 55px;margin-bottom: 25px">
                        <div class="col-md-6 col-item">
                            <span class="adv-company-name">Meter No:</span>
                        </div>
                        <div class="col-md-6 col-item">
                            <span id="meterno" class="adv-company-name" style="font-weight:bold; font-size:30px;">Peter Bamidele</span>
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-md-6 col-item adv-company-name">
                            <span class="adv-company-name">Amount:</span>
                        </div>
                        <div class="col-md-6 col-item">
                            <span class="amount-currency">SSL :</span>
                            <span id="pamount" class="adv-amount-figure" style="font-weight:bold; font-size:30px;">100.00</span>

                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary md-close" type="button" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary md-close" id="rechargeBtn" type="button" data-dismiss="modal">Proceed</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCart">
    <div class="modal-dialog" style="width:28%;">
        <div class="modal-content">
            <div class="modal-body" id="printSection">
                <div class="row padded" style="text-align:center;" id="gen-invoice">
                    <div class="row" style="font-weight:bold; font-size:30px;"><span class="text-muted">V</span>ENDTECH</div>
                    <h3>ELECTRICITY PURCHASE</h3>
                </div>
                <hr class="bg-dark" style="border: 1px solid grey; background: grey;">
                <div class="row">
                    <div class="col-md-6 col-sm-6 col-xs-6 text-left">
                        <span class="cust_bold">Date</span>
                        <p class="cust_bold">@DateTime.UtcNow</p>
                    </div>
                    <div class="col-md-6 col-sm-6 col-xs-6 text-right">
                        <span class="text-light">Vendor ID</span>
                        <p class="cust_bold">Office Coporate</p>
                    </div>
                </div> 
                <div class="row">
                    <div class="col-md-10 padded">
                        <div class="row"><span class="cust_bold">Customer : </span><span id="customer_name"> Emmanuel Favour</span></div>
                        <div class="row"><span class="cust_bold">Account # : </span><span id="customer_account_number"> 234567890</span></div>
                        <div class="row"><span class="cust_bold">Address : </span><span id="customer_address"> 52 Oshola str. Ogba Ikeja, Lagos Nigeria</span></div>
                    </div>
                </div> 
                <div class="row">
                    <div class="col-md-10 padded">
                        <div class="cust_bold row">Meter #: <span id="meter_number"> 1345678909876</span> </div>
                        <div class="cust_bold row">Tariff : <span id="current_tarrif"> 569</span> </div>
                        <div class="row">Amount Tendered : <span class="cust_bold"> le: <span id="amount_tender"> 1000,000</span></span></div>
                    </div>
                </div>
                <div class="row" style="margin: 10px;">
                    <span class="col-md-1 col-sm-1 col-xs-1 cust_bold"><div class="cust_line"></div></span>
                    <span class="col-md-3 col-sm-3 col-xs-3 cust_bold">  Deductions </span>
                    <span class="col-md-7 col-sm-7 col-xs-7 cust_bold"><div class="cust_line"></div></span>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div style="border:none;" class="col-md-12 col-sm-12 col-xs-12">
                            <div class="row">
                                <div class="col-md-5 col-sm-5 col-xs-5"> GST: </div>
                                <div class="cust_bold col-md-5 col-sm-5 col-xs-5"> le: <span id="gst"> 150,000</span></div>
                            </div>
                            <div class="row">
                                <div class="col-md-5 col-sm-5 col-xs-5"> Service charge:</div>
                                <div class="cust_bold col-md-5 col-sm-5 col-xs-5"> le: <span id="service_charge"> 10,500</span></div>
                            </div>

                            <div class="row">
                                <div class="col-md-5 col-sm-5 col-xs-5"> Debit recovery:</div>
                                <div class="cust_bold col-md-5 col-sm-5 col-xs-5"> le: <span id="debit_recovery"> 350,000</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" style="margin: 10px;">
                    <span class="col-md-1 col-sm-1 col-xs-1 cust_bold"><div class="cust_line"></div></span>
                    <span class="col-md-3 col-sm-3 col-xs-3 cust_bold">  TOTAL </span>
                    <span class="col-md-7 col-sm-7 col-xs-7 cust_bold"><div class="cust_line"></div></span>
                </div>

                <div class="row">
                    <div class="col-md-12">

                        <div style="border:none;" class="col-md-12 col-sm-12 col-xs-12">
                            <div class="row">
                                <div class="col-md-5 col-sm-5 col-xs-5"> Cost of units:</div>
                                <div class="cust_bold col-md-5 col-sm-5 col-xs-5"> le: <span id="cost_of_units"> 489,500</span></div>
                            </div>
                            <div class="row">
                                <div class="col-md-5 col-sm-5 col-xs-5"> Units:</div>
                                <div class="cust_bold col-md-5 col-sm-5 col-xs-5"><span id="units"> 1245.4</span></div>
                            </div>
                        </div>
                    </div>
                </div> 
                <div class="row" style="text-align: center;">
                    <div class="col-md-12 col-lg-12 col-sm-12 col-xs-12" style="text-align: center; ">
                        <p class="dashed_border col-lg-12 col-md-12 col-sm-12 col-xs-12 col-xs-12" style="border-right: none; border-left: none; ">
                            <span id="generated_token" class="col-md-12 col-sm-12 col-xs-12">1234 5678 9011 1213 1411</span>
                        </p>
                    </div>
                </div> 

                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <em>
                            EDSA Serial #: <span class="edsa_serial">123467</span>
                            <p>VENDTECH Serial #: <span id="vendtech_serial_code">1234356</span> </p>
                            www.vendtechsl.com
                            <p>Call +232 76 990 990</p>
                        </em>

                    </div>
                </div>
                <div class="row modal-footer">
                    <div class="col-md-7 col-sm-7 col-xs-7 text-center">
                        <span id="barcode">50218 </span>
                    </div>
                    <div class="col-md-5 col-sm-5 col-xs-5 row" style=" padding: 0; margin: 0px;">
                        <button type="button" class="btn btn-outline-primary waves-effect waves-light ">SMS</button>
                        <button class="btn btn-primary waves-effect waves-light " onclick="printReceipt()">PRINT</button>
                        @*js:window.print()*@
                    </div>

                </div>
            </div>
            <!-- modal-footer -->


        </div>

    </div>
</div>


@*<div class="modal fade" id="modalCart">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Receipt</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body" id="printSection">
                    <center id="top">
                        <div class="logo"></div>
                    </center>
                    <div id="gen-invoice">
                        <div class="row">

                            <div class="col-md-9 col-lg-9 col-sm-9">
                                <div id="invoice heading">
                                    <h2>ELECTRICITY PURCHASE</h2>
                                </div>
                            </div>

                            <div class="col-md-3 col-lg-3 col-sm-3">
                                <div id="date">
                                    <h5>DATE: @DateTime.Now </h5>
                                </div>
                            </div>


                        </div>
                    </div>
                    <div class="customer-details">
                        <div id="r_address">
                            Address : &nbsp; street city, state 0000</br>
                            Email   : JohnDoe@gmail.com</br>
                            Phone   : 555-555-5555</br>
                        </div>
                        <hr>
                    </div>

                    <div class="customer-details">
                        <div id="tender"></div>
                        <hr>
                    </div>

                    <div class="customer-details">

                        <div id="tarrif">

                        </div>
                        <hr>
                    </div>

                    <div class="info">
                        <div id="token">Contact Info</div>
                    </div>


                    <div id="serial-details">
                        <p>SERIAL:</p>
                        <p>TERMINAL ID:</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary waves-effect waves-light">SMS</button>
                    <button class="btn btn-primary waves-effect waves-light" onclick="js:window.print()">PRINT</button>
                </div>
            </div>
        </div>
    </div>*@


@section scripts{
    <script src="~/Scripts/UserScripts/meter.js"></script>
    <link href="~/Content/transdetails.css" rel="stylesheet" />
    <link href="~/Content/pos_receipt.css" rel="stylesheet" />
    <script>

        function printReceipt() {
            debugger;
           var prtContent = document.getElementById("printSection");
            var WinPrint = window.open('', '', 'left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0');
            WinPrint.document.write('<link href="~/Content/pos_receipt.css" rel="stylesheet" />');
            WinPrint.document.write(prtContent.innerHTML);
            WinPrint.document.close();
            WinPrint.focus();
            WinPrint.print();
            WinPrint.close();
        }

        $(document).ready(function () {
            $(".savebttn").click(function () {
                if (!$("#Amount").val() || $("#Amount").val() == "0") {
                    $.ShowMessage($('div.messageAlert'), "Please Enter Amount", MessageType.Error);
                    return;
                } else if (!$("#MeterNumber").val() && !$("#meterDrp").val()) {
                    $.ShowMessage($('div.messageAlert'), "Please enter meter number or select a meter.", MessageType.Error);
                    return;
                } else {
                    let meterno = ""
                    if ($("#MeterNumber").val() == "") {
                        meterno = $("#meterDrp option:selected").text()
                    } else {
                        meterno = $("#MeterNumber").val();
                    }

                    $("#meterno").html(meterno)
                    $("#pamount").html(thousands_separators($("#Amount").val()))
                    $("#form-bp1").modal("show")
                }
            })

            $("#AmountDisplay").on('keyup', function (evt) {
                if ($("#AmountDisplay").val() == "") {
                    return false;
                }
                if (evt.which != 110 ){//not a fullstop
                    var n = parseFloat($(this).val().replace(/\,/g,''),10);
                    $(this).val(n.toLocaleString());
                }
            });
        })
        $(function () {
            $("#posDrp").on("change", function () {
                $.ajax({
                    url: '/Pos/GetPosBalance?posId=' + $("#posDrp").val(),
                    success: function (res) {
                        $("#balanceSpan").text("SSL : " + thousands_separators(res.balance));
                    }
                })
            }
            )
        })
        function isNumber(evt) {
            var iKeyCode = (evt.which) ? evt.which : evt.keyCode
            if (iKeyCode > 31 && (iKeyCode < 48 || iKeyCode > 57))
                return false;

            return true;
        }
        function onSelectMeter() {
            if ($("#meterDrp").val()) {
                $("#MeterNumber").attr("disabled", "disabled");
                $("#saveMeterChk").attr("disabled", "disabled");
                $("#saveMeterChk").removeAttr("checked");
            }
            else {
                $("#MeterNumber").removeAttr("disabled");
                $("#saveMeterChk").removeAttr("disabled");

            }
        }
        function onChangeMeterNumber() {
            var val = $("#MeterNumber").val();
            if (val && val.length > 0) {
                $("#meterDrp").attr("disabled", "disabled");
            }
            else {
                $("#meterDrp").removeAttr("disabled");
            }
        }
        function thousands_separators(num) {
            var num_parts = num.toString().split(".");
            num_parts[0] = num_parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return num_parts.join(".");
        }
        function amountFormatter() { 
            $("#pay_Now_Btn").prop('disabled', false);

            var displayVal = $("#AmountDisplay").val();
            var val = "";
            if (displayVal) {
                var cc = displayVal.replace(/\,/g, "");
                $("#Amount").val(cc);
                val = $("#Amount").val();

                var amt_to_display = thousands_separators(val);
                var wallet_balance = '@(string.Format("{0:N0}", ViewBag.walletBalance))';

                if (Number(amt_to_display.replace(/,/g,"")) > Number(wallet_balance.replace(/,/g,""))) { 
                    $("#pay_Now_Btn").prop('disabled', true); 
                     $.ShowMessage($('div.messageAlert'), "Walllet balance is insufficient to make purchase.", MessageType.Error);
                    return false;
                }
                $("#AmountDisplay").val();
            }
        }
        function isNumber(evt) {
            var iKeyCode = (evt.which) ? evt.which : evt.keyCode
            if (iKeyCode > 31 && (iKeyCode < 48 || iKeyCode > 57))
                return false;

            return true;
        }
    </script>
}
<style type="text/css">
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        margin: 0;
    }
</style>
